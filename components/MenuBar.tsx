import React, { useState, useRef, useEffect } from 'react';
import { MenuIcon, CloseIcon, FilePlusIcon, SaveIcon, FolderIcon, DownloadIcon, PrinterIcon, UndoIcon, RedoIcon, ScissorsIcon, CopyIcon, ClipboardIcon, SelectAllIcon, SearchIcon, LinkIcon, ImageIcon, TableIcon, MinusIcon, MessageSquareIcon, CodeIcon, BarChartIcon, EyeIcon, MaximizeIcon, InfoIcon, OmegaIcon, PaintBrushIcon, PdfIcon, SquareIcon, CircleIcon, TriangleIcon, TypeIcon, ChevronRightIcon, FileTextIcon, SplitSquareVerticalIcon, RectangleVerticalIcon, RectangleHorizontalIcon, LanguageIcon, SparklesIcon, Volume2Icon, KeyboardIcon, ChecklistIcon, UploadCloudIcon, PencilIcon, SlashIcon } from './icons/EditorIcons';
import type { ShapeType } from '../App';
import type { Language } from '../lib/translations';

type MenuItem =
  | {
      label: string;
      action?: () => void;
      icon?: React.ReactNode;
      separator?: false;
      items?: MenuItem[];
    }
  | {
      label?: string;
      action?: () => void;
      icon?: React.ReactNode;
      separator: true;
      items?: never;
    };

interface MenuBarProps {
  onNewDocument: () => void;
  onSave: () => void;
  onViewSaved: () => void;
  onExportToWord: () => void;
  onExportToPdf: () => void;
  onPrint: () => void;
  onEditAction: (command: string) => void;
  onOpenFindReplace: () => void;
  onCopyFormatting: () => void;
  onInsertLink: () => void;
  onInsertImage: () => void;
  onInsertTable: () => void;
  onInsertShape: (shapeType: ShapeType) => void;
  onInsertHorizontalRule: () => void;
  onInsertPageBreak: () => void;
  onInsertDrawing: () => void;
  onAddComment: () => void;
  onOpenSourceCode: () => void;
  onOpenWordCount: () => void;
  onToggleFullscreen: () => void;
  onPreview: () => void;
  onShowComments: () => void;
  onToggleAiSidekick: () => void;
  onOpenSpecialCharacters: () => void;
  isSaving: boolean;
  lastSaved: number | null;
  isDocumentSaved: boolean;
  onOpenPageSetup: () => void;
  onOpenAboutModal: () => void;
  onOpenShortcuts: () => void;
  onSetLanguage: (lang: Language) => void;
  onReadAloud: () => void;
  isReadingAloud: boolean;
  onToggleSpellcheck: () => void;
  isSpellcheckEnabled: boolean;
  onOpenFileImport: () => void;
  t: (key: string, replacements?: { [key: string]: string | number }) => string;
}

const MenuDropdown: React.FC<{ label: string; items: MenuItem[] }> = ({ label, items }) => {
  const [isOpen, setIsOpen] = useState(false);
  const menuRef = useRef<HTMLDivElement>(null);
  const [openSubmenu, setOpenSubmenu] = useState<string | null>(null);

  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      if (menuRef.current && !menuRef.current.contains(event.target as Node)) {
        setIsOpen(false);
        setOpenSubmenu(null);
      }
    };
    document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, []);

  const handleAction = (action?: () => void) => {
    if (action) {
      action();
      setIsOpen(false);
      setOpenSubmenu(null);
    }
  };

  return (
    <div className="relative" ref={menuRef} onMouseLeave={() => setOpenSubmenu(null)}>
      <button
        onClick={() => setIsOpen(!isOpen)}
        aria-haspopup="true"
        aria-expanded={isOpen}
        className="px-3 py-1.5 text-sm rounded-md hover:bg-gray-200 dark:hover:bg-gray-700 focus:outline-none focus:ring-1 focus:ring-blue-500 transition-colors duration-150"
      >
        {label}
      </button>
      {isOpen && (
        <div className="absolute left-0 mt-2 w-56 bg-white dark:bg-gray-800 rounded-md shadow-lg py-1 z-10 border border-gray-200 dark:border-gray-700" role="menu">
          {items.map((item, index) =>
            item.separator ? (
              <div key={`sep-${index}`} className="border-t border-gray-200 dark:border-gray-700 my-1" />
            ) : (
              <div key={item.label} className="relative" onMouseEnter={() => item.items && setOpenSubmenu(item.label)}>
                  <button
                    onClick={() => handleAction(item.action)}
                    className="text-left w-full px-3 py-1.5 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-600 flex items-center justify-between"
                    role="menuitem"
                    disabled={!item.action && !item.items}
                  >
                    <div className="flex items-center">
                      {item.icon}
                      <span>{item.label}</span>
                    </div>
                    {item.items && <ChevronRightIcon />}
                  </button>
                  {item.items && openSubmenu === item.label && (
                    <div className="absolute left-full -top-1 ml-1 w-48 bg-white dark:bg-gray-800 rounded-md shadow-lg py-1 z-20 border border-gray-200 dark:border-gray-700">
                        {item.items.map(subItem => (
                             <button
                                key={subItem.label}
                                onClick={() => handleAction(subItem.action)}
                                className="text-left w-full px-3 py-1.5 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-600 flex items-center"
                                role="menuitem"
                            >
                                {subItem.icon}
                                <span>{subItem.label}</span>
                            </button>
                        ))}
                    </div>
                  )}
              </div>
            )
          )}
        </div>
      )}
    </div>
  );
};


const MobileAccordionItem: React.FC<{ 
    label: string; 
    items: MenuItem[]; 
    onAction: (action?: () => void) => void;
    isOpen: boolean;
    onToggle: () => void;
}> = ({ label, items, onAction, isOpen, onToggle }) => {
    return (
        <li className="border-b border-gray-200 dark:border-gray-700 last:border-b-0">
            <button
                onClick={onToggle}
                className="w-full text-left flex justify-between items-center p-4"
                aria-expanded={isOpen}
            >
                <span className="text-lg font-medium">{label}</span>
                <svg className={`w-5 h-5 transform transition-transform text-gray-500 ${isOpen ? 'rotate-180' : ''}`} fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 9l-7 7-7-7"></path></svg>
            </button>
            {isOpen && (
                <div className="pb-2 px-4">
                    <div className="border-t border-gray-200 dark:border-gray-700 pt-2">
                        {items.map((item, index) =>
                            item.separator ? (
                                <div key={`sep-${index}`} className="border-t border-gray-200 dark:border-gray-700 my-1" />
                            ) : item.items ? (
                                <div key={item.label}>
                                    <h3 className="px-2 py-2 text-sm font-semibold text-gray-500 dark:text-gray-400 flex items-center">{item.icon} {item.label}</h3>
                                    <div className="pl-4">
                                        {item.items.map(subItem => (
                                             <button
                                                key={subItem.label}
                                                onClick={() => onAction(subItem.action)}
                                                className="text-left block w-full px-2 py-2 text-base text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-600 rounded-md flex items-center"
                                            >
                                                {subItem.icon}
                                                <span>{subItem.label}</span>
                                            </button>
                                        ))}
                                    </div>
                                </div>
                            ) : (
                                <button
                                    key={item.label}
                                    onClick={() => onAction(item.action)}
                                    className="text-left block w-full px-2 py-2 text-base text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-600 rounded-md flex items-center"
                                >
                                    {item.icon}
                                    <span>{item.label}</span>
                                </button>
                            )
                        )}
                    </div>
                </div>
            )}
        </li>
    );
};

const AutoSaveStatus: React.FC<{ isSaving: boolean; lastSaved: number | null; isDocumentSaved: boolean; t: (key: string, replacements?: { [key: string]: string | number }) => string; }> = ({ isSaving, lastSaved, isDocumentSaved, t }) => {
    if (!isDocumentSaved) return null;

    let statusText = '';
    if (isSaving) {
        statusText = t('autosave.saving');
    } else if (lastSaved) {
        const time = new Date(lastSaved).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        statusText = t('autosave.savedAt', { time });
    }

    return (
        <div className="hidden md:flex items-center text-sm text-gray-500 dark:text-gray-400 transition-opacity">
            {statusText}
        </div>
    );
};

const MenuBar: React.FC<MenuBarProps> = (props) => {
    const { t } = props;
    const [isMobileMenuOpen, setIsMobileMenuOpen] = useState(false);
    const [openAccordion, setOpenAccordion] = useState<string | null>(null);

    const handleAccordionToggle = (label: string) => {
        setOpenAccordion(currentOpen => (currentOpen === label ? null : label));
    };

    const fileMenuItems: MenuItem[] = [
        { label: t('menu.fileNew'), action: props.onNewDocument, icon: <FilePlusIcon isMenuIcon /> },
        { label: t('menu.fileSave'), action: props.onSave, icon: <SaveIcon isMenuIcon /> },
        { label: t('menu.fileViewSaved'), action: props.onViewSaved, icon: <FolderIcon isMenuIcon /> },
        { separator: true },
        { label: t('menu.fileImport'), action: props.onOpenFileImport, icon: <UploadCloudIcon isMenuIcon /> },
        { separator: true },
        { label: t('menu.fileExportWord'), action: props.onExportToWord, icon: <DownloadIcon isMenuIcon /> },
        { label: t('menu.fileExportPdf'), action: props.onExportToPdf, icon: <PdfIcon isMenuIcon /> },
        { separator: true },
        { label: t('menu.filePageSetup'), action: props.onOpenPageSetup, icon: <FileTextIcon isMenuIcon /> },
        { separator: true },
        { label: t('menu.filePrint'), action: props.onPrint, icon: <PrinterIcon isMenuIcon /> },
    ];

    const editMenuItems: MenuItem[] = [
        { label: t('menu.editUndo'), action: () => props.onEditAction('undo'), icon: <UndoIcon isMenuIcon /> },
        { label: t('menu.editRedo'), action: () => props.onEditAction('redo'), icon: <RedoIcon isMenuIcon /> },
        { separator: true },
        { label: t('menu.editCut'), action: () => props.onEditAction('cut'), icon: <ScissorsIcon isMenuIcon /> },
        { label: t('menu.editCopy'), action: () => props.onEditAction('copy'), icon: <CopyIcon isMenuIcon /> },
        { label: t('menu.editPaste'), action: () => props.onEditAction('paste'), icon: <ClipboardIcon isMenuIcon /> },
        { separator: true },
        { label: t('menu.editFormatPainter'), action: props.onCopyFormatting, icon: <PaintBrushIcon isMenuIcon /> },
        { separator: true },
        { label: t('menu.editSelectAll'), action: () => props.onEditAction('selectAll'), icon: <SelectAllIcon isMenuIcon /> },
        { separator: true },
        { label: t('menu.editFindReplace'), action: props.onOpenFindReplace, icon: <SearchIcon isMenuIcon /> },
    ];
    
    const insertMenuItems: MenuItem[] = [
        { label: t('menu.insertLink'), action: props.onInsertLink, icon: <LinkIcon isMenuIcon /> },
        { label: t('menu.insertImage'), action: props.onInsertImage, icon: <ImageIcon isMenuIcon /> },
        { label: t('menu.insertDrawing'), action: props.onInsertDrawing, icon: <PencilIcon isMenuIcon /> },
        { label: t('menu.insertTable'), action: props.onInsertTable, icon: <TableIcon isMenuIcon /> },
        { label: t('menu.insertShapes'), icon: <SquareIcon isMenuIcon />, items: [
            { label: t('menu.shapeTextbox'), action: () => props.onInsertShape('textbox'), icon: <TypeIcon isMenuIcon /> },
            { label: t('menu.shapeRectangle'), action: () => props.onInsertShape('rectangle'), icon: <SquareIcon isMenuIcon /> },
            { label: t('menu.shapeCircle'), action: () => props.onInsertShape('circle'), icon: <CircleIcon isMenuIcon /> },
            { label: t('menu.shapeTriangle'), action: () => props.onInsertShape('triangle'), icon: <TriangleIcon isMenuIcon /> },
            { label: t('menu.shapeLine'), action: () => props.onInsertShape('line'), icon: <SlashIcon isMenuIcon /> },
        ] },
        { label: t('menu.insertHorizontalLine'), action: props.onInsertHorizontalRule, icon: <MinusIcon isMenuIcon /> },
        { label: t('menu.insertPageBreak'), action: props.onInsertPageBreak, icon: <SplitSquareVerticalIcon isMenuIcon /> },
        { label: t('menu.insertSpecialChar'), action: props.onOpenSpecialCharacters, icon: <OmegaIcon isMenuIcon /> },
        { separator: true },
        { label: t('menu.insertComment'), action: props.onAddComment, icon: <MessageSquareIcon isMenuIcon /> },
    ];
    
    const formatMenuItems: MenuItem[] = [
        {
            label: t('menu.formatPageOrientation'),
            icon: <RectangleHorizontalIcon isMenuIcon />,
            items: [
                { label: t('menu.orientationPortrait'), action: () => {}, icon: <RectangleVerticalIcon isMenuIcon /> },
                { label: t('menu.orientationLandscape'), action: () => {}, icon: <RectangleHorizontalIcon isMenuIcon /> },
            ]
        }
    ];
    
    const toolsMenuItems: MenuItem[] = [
        { label: t('menu.toolsAiAssistant'), action: props.onToggleAiSidekick, icon: <SparklesIcon isMenuIcon /> },
        { label: t('menu.toolsSourceCode'), action: props.onOpenSourceCode, icon: <CodeIcon isMenuIcon /> },
        { label: t('menu.toolsWordCount'), action: props.onOpenWordCount, icon: <BarChartIcon isMenuIcon /> },
        { 
            label: props.isReadingAloud ? t('menu.aiStopReading') : t('menu.aiReadAloud'), 
            action: props.onReadAloud, 
            icon: props.isReadingAloud ? <SquareIcon isMenuIcon /> : <Volume2Icon isMenuIcon /> 
        },
        { separator: true },
        {
            label: t('menu.toolsLanguage'),
            icon: <LanguageIcon isMenuIcon />,
            items: [
                { label: t('menu.langEnglish'), action: () => props.onSetLanguage('en') },
                { label: t('menu.langGeorgian'), action: () => props.onSetLanguage('ka') },
                { label: t('menu.langSpanish'), action: () => props.onSetLanguage('es') },
            ]
        },
    ];

    const viewMenuItems: MenuItem[] = [
        { label: t('menu.viewPreview'), action: props.onPreview, icon: <EyeIcon isMenuIcon /> },
        { label: t('menu.viewFullscreen'), action: props.onToggleFullscreen, icon: <MaximizeIcon isMenuIcon /> },
        { separator: true },
        { label: t('menu.viewShowComments'), action: props.onShowComments, icon: <MessageSquareIcon isMenuIcon /> },
        { separator: true },
        { label: props.isSpellcheckEnabled ? t('menu.viewHideSpelling') : t('menu.viewShowSpelling'), action: props.onToggleSpellcheck, icon: <ChecklistIcon isMenuIcon /> },
    ];

    const helpMenuItems: MenuItem[] = [
        { label: t('menu.helpShortcuts'), action: props.onOpenShortcuts, icon: <KeyboardIcon isMenuIcon /> },
        { label: t('menu.helpAbout'), action: props.onOpenAboutModal, icon: <InfoIcon isMenuIcon /> }
    ];

    const menus = [
        { label: t('menu.file'), items: fileMenuItems },
        { label: t('menu.edit'), items: editMenuItems },
        { label: t('menu.insert'), items: insertMenuItems },
        { label: t('menu.tools'), items: toolsMenuItems },
        { label: t('menu.view'), items: viewMenuItems },
        { label: t('menu.help'), items: helpMenuItems },
    ];

    const handleMobileAction = (action?: () => void) => {
        if(action) action();
        setIsMobileMenuOpen(false);
    };

    return (
        <nav className="px-2 py-1 flex items-center">
            <div className="md:hidden">
                <button
                    onClick={() => setIsMobileMenuOpen(true)}
                    className="p-2 rounded-md hover:bg-gray-200 dark:hover:bg-gray-700"
                    aria-label="Open menu"
                >
                    <MenuIcon />
                </button>
            </div>

            <div className="hidden md:flex items-center gap-1">
                {menus.map(menu => <MenuDropdown key={menu.label} label={menu.label} items={menu.items} />)}
            </div>
            
            <div className="flex-grow" />

            <AutoSaveStatus isSaving={props.isSaving} lastSaved={props.lastSaved} isDocumentSaved={props.isDocumentSaved} t={t} />
            
            {isMobileMenuOpen && (
                <div className="fixed inset-0 bg-white dark:bg-gray-900 z-50 flex flex-col" role="dialog" aria-modal="true">
                    <div className="flex justify-between items-center p-4 border-b border-gray-200 dark:border-gray-700">
                        <h2 className="text-lg font-semibold">Menu</h2>
                        <button onClick={() => setIsMobileMenuOpen(false)} className="p-2" aria-label="Close menu">
                            <CloseIcon />
                        </button>
                    </div>
                    <ul className="flex-grow overflow-y-auto">
                        {menus.map(menu => (
                            <MobileAccordionItem 
                                key={menu.label} 
                                label={menu.label} 
                                items={menu.items} 
                                onAction={handleMobileAction} 
                                isOpen={openAccordion === menu.label} 
                                onToggle={() => handleAccordionToggle(menu.label)} 
                            />
                        ))}
                    </ul>
                </div>
            )}
        </nav>
    );
};

export default MenuBar;